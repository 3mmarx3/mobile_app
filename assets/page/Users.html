<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شوب أدمن - إدارة العملاء</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../style/style.css">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
        import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDlKhp5gKE6l5BFBOBcLv6JZB3xIOnwqDo",
            authDomain: "shop-732bb.firebaseapp.com",
            databaseURL: "https://shop-732bb-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "shop-732bb",
            storageBucket: "shop-732bb.firebasestorage.app",
            messagingSenderId: "650792166626",
            appId: "1:650792166626:web:4ae7de7821542520096abb"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const userModal = new bootstrap.Modal(document.getElementById('userModal'));
        let currentUserData = {};

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "/auth/login.html";
                return;
            }
            const userRef = doc(db, "users", user.uid);
            const userSnap = await getDoc(userRef);
            if (!userSnap.exists() || userSnap.data().role !== 'admin') {
                await signOut(auth);
                window.location.href = "/auth/login.html";
                return;
            }
            loadUsers();
        });

        function formatTime(timeStr) {
            if (!timeStr) return 'غير متوفر';
            if (timeStr.toString().includes('PM') || timeStr.toString().includes('AM')) return timeStr;
            const parts = timeStr.split(':');
            if (parts.length >= 2) {
                const hours = parseInt(parts[0]);
                const minutes = parseInt(parts[1]);
                if (!isNaN(hours)) {
                    let h = hours % 12;
                    h = h ? h : 12;
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    const minStr = !isNaN(minutes) ? minutes.toString().padStart(2, '0') : '00';
                    return `${h}:${minStr} ${ampm}`;
                }
            }
            return timeStr;
        }

        async function extractFileNameFromUrl(url) {
            if (!url) return null;
            try {
                const urlObj = new URL(url);
                const pathname = decodeURIComponent(urlObj.pathname);
                const matches = pathname.match(/place_images%2F([^?]+)/);
                if (matches && matches[1]) {
                    return matches[1];
                }
                return null;
            } catch (error) {
                console.error('خطأ في استخراج اسم الملف:', error);
                return null;
            }
        }

        async function getPlaceImageUrl(u) {
            let imageUrl = u.image || u.placeImage;
            if (!imageUrl || imageUrl.trim() === '') {
                return "https://ui-avatars.com/api/?name=المكان&background=6366f1&color=fff&size=500";
            }
            
            if (imageUrl.startsWith('https://')) {
                return imageUrl;
            }
            
            try {
                const fileName = await extractFileNameFromUrl(imageUrl) || imageUrl;
                const pathReference = ref(storage, `place_images/${fileName}`);
                const url = await getDownloadURL(pathReference);
                return url;
            } catch (error) {
                console.error("خطأ في تحميل الصورة:", error);
                return imageUrl.startsWith('https://') ? imageUrl : "https://ui-avatars.com/api/?name=غير+متوفر&background=ef4444&color=fff&size=500";
            }
        }

        async function createTableRow(u, key) {
            const statusText = u.state ? 'نشط' : 'غير نشط';
            const statusClass = u.state ? 'active' : 'inactive';
            const userPhoto = u.photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(u.name || 'User')}&background=${u.state ? '6366f1' : 'ef4444'}&color=fff`;
            
            const placeImageUrl = await getPlaceImageUrl(u);

            return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="${userPhoto}" class="user-avatar me-2" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                            <strong>${u.name || 'غير محدد'}</strong>
                        </div>
                    </td>
                    <td>${u.phone || '-'}</td>
                    <td>${u.joinDate || '-'}</td>
                    <td dir="ltr">${u.joinTime ? formatTime(u.joinTime) : '-'}</td>
                    <td>${u.ordersCount || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="openPlaceImageModal('${placeImageUrl.replace(/'/g, "\\'")}')">
                            <i class="fas fa-image"></i> عرض الصورة
                        </button>
                    </td>
                    <td><span class="badge badge-custom ${statusClass}">${statusText}</span></td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <label class="switch">
                                <input type="checkbox" ${u.state ? 'checked' : ''} onchange="toggleUser('${key}', this.checked)">
                                <span class="slider"></span>
                            </label>
                            <button class="btn btn-sm btn-light" onclick="openUserModal('${key}')">
                                <i class="fas fa-eye text-primary"></i>
                            </button>
                            <button class="btn btn-sm btn-light" onclick="deleteUser('${key}')">
                                <i class="fas fa-trash text-danger"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        async function loadUsers() {
            const tbodyClients = document.querySelector('#usersTableClients tbody');
            tbodyClients.innerHTML = '<tr><td colspan="8" class="text-center">جاري تحميل البيانات...</td></tr>';
            const usersRef = collection(db, "users");
            onSnapshot(usersRef, async (snapshot) => {
                tbodyClients.innerHTML = '';
                let clientCount = 0;
                const rows = [];
                for (const docSnap of snapshot.docs) {
                    const u = docSnap.data();
                    const key = docSnap.id;
                    if (u.role !== 'admin') {
                        currentUserData[key] = u;
                        const rowHTML = await createTableRow(u, key);
                        rows.push(rowHTML);
                        clientCount++;
                    }
                }
                tbodyClients.innerHTML = rows.length > 0 ? rows.join('') : '<tr><td colspan="8" class="text-center">لا يوجد عملاء</td></tr>';
                document.getElementById('client-count').textContent = `(${clientCount})`;
            }, (error) => {
                tbodyClients.innerHTML = `<tr><td colspan="8" class="text-center text-danger">خطأ: ${error.message}</td></tr>`;
            });
        }

        window.toggleUser = async function(key, newState) {
            try {
                const userRef = doc(db, "users", key);
                await updateDoc(userRef, { state: newState });
            } catch (e) {
                alert("خطأ في تحديث الحالة: " + e.message);
            }
        };

        window.deleteUser = async function(key) {
            if (confirm('هل أنت متأكد من حذف هذا العميل نهائياً؟ هذا الإجراء لا يمكن التراجع عنه.')) {
                try {
                    const userRef = doc(db, "users", key);
                    await deleteDoc(userRef);
                    alert("تم حذف العميل بنجاح.");
                } catch (e) {
                    alert("فشل الحذف: " + e.message);
                }
            }
        };

        window.openUserModal = async function(key) {
            const u = currentUserData[key];
            if (!u) return;
            const statusText = u.state ? 'نشط' : 'غير نشط';
            const statusClass = u.state ? 'active' : 'inactive';
            const buttonText = u.state ? 'تعطيل/حظر' : 'تفعيل العميل';
            const userPhoto = u.photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(u.name || 'User')}&background=${u.state ? '6366f1' : 'ef4444'}&color=fff`;
            
            const placeImageUrl = await getPlaceImageUrl(u);

            document.getElementById('modalAvatar').src = userPhoto;
            document.getElementById('modalName').textContent = u.name || 'غير محدد';
            document.getElementById('modalPhone').textContent = u.phone || '-';
            document.getElementById('modalEmail').textContent = u.email || '-';
            document.getElementById('modalLocation').textContent = u.location || '-';
            document.getElementById('modalPlaceName').textContent = u.placeName || '-';
            document.getElementById('modalDate').textContent = u.joinDate || '-';
            document.getElementById('modalTime').textContent = u.joinTime ? formatTime(u.joinTime) : '-';
            document.getElementById('modalOrdersCount').textContent = u.ordersCount || 0;
            const statusEl = document.getElementById('modalStatus');
            statusEl.textContent = statusText;
            statusEl.className = 'badge badge-custom ' + statusClass;
            const actionBtn = document.getElementById('userActionButton');
            actionBtn.style.display = 'inline-block';
            actionBtn.textContent = buttonText;
            actionBtn.className = `btn btn-custom ${u.state ? 'btn-danger' : 'btn-success'}`;
            actionBtn.onclick = () => toggleUserFromModal(key, !u.state, buttonText);
            document.getElementById('placeImageModalImg').src = placeImageUrl;
            userModal.show();
        };

        window.toggleUserFromModal = async function(key, newState, buttonText) {
            if (confirm(`هل أنت متأكد من ${buttonText}؟`)) {
                try {
                    const userRef = doc(db, "users", key);
                    await updateDoc(userRef, { state: newState });
                    userModal.hide();
                } catch (e) {
                    alert("فشل الإجراء: " + e.message);
                }
            }
        };

        window.openPlaceImageModal = function(imageUrl) {
            document.getElementById('placeImageModalImg').src = imageUrl;
            new bootstrap.Modal(document.getElementById('placeImageModal')).show();
        };

        document.getElementById('mobileMenuBtn')?.addEventListener('click', () => {
            document.getElementById('sidebar')?.classList.toggle('active');
        });
    </script>
</head>
<body>
    <header id="header"></header>
    <div class="main-content">
        <div class="header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 class="mb-0" id="page-title">إدارة العملاء</h2>
            </div>
            <div class="user-info">
                <span>مرحباً، <strong>المشرف</strong></span>
            </div>
        </div>
        <div id="page-container">
            <div id="users" class="page active">
                <div class="container-fluid">
                    <div class="mb-4">
                        <h4>العملاء <span id="client-count" class="text-primary fw-bold">(...)</span></h4>
                    </div>
                    <div class="card-custom">
                        <div class="table-responsive table-responsive-custom">
                            <table class="table table-custom" id="usersTableClients">
                                <thead>
                                    <tr>
                                        <th>العميل</th>
                                        <th>الهاتف</th>
                                        <th>التاريخ</th>
                                        <th>الوقت</th>
                                        <th>عدد الطلبات</th>
                                        <th>صورة المكان</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="modal modal-custom fade" id="userModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">الملف الشخصي</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center">
                                <img id="modalAvatar" src="" class="user-avatar mb-3" style="width:120px;height:120px;border-radius:50%;object-fit:cover;">
                                <h4 id="modalName" class="mb-3"></h4>
                                <p class="mb-2"><strong>الهاتف:</strong> <span id="modalPhone"></span></p>
                                <p class="mb-2"><strong>البريد الإلكتروني:</strong> <span id="modalEmail"></span></p>
                                <p class="mb-2"><strong>الموقع:</strong> <span id="modalLocation"></span></p>
                                <p class="mb-2"><strong>اسم المكان:</strong> <span id="modalPlaceName"></span></p>
                                <p class="mb-2"><strong>التاريخ:</strong> <span id="modalDate"></span></p>
                                <p class="mb-2"><strong>الوقت:</strong> <span id="modalTime"></span></p>
                                <p class="mb-4"><strong>عدد الطلبات:</strong> <span id="modalOrdersCount"></span></p>
                                <div class="row mb-4 user-info-grid">
                                    <div class="col-6 mb-3">
                                        <p class="mb-1"><strong>الحالة</strong></p>
                                        <span id="modalStatus" class="badge badge-custom"></span>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-center gap-2">
                                    <button id="userActionButton" class="btn btn-custom"></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="placeImageModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">صورة المكان</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center">
                                <img id="placeImageModalImg" src="" class="img-fluid rounded" style="max-height:80vh;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../app/header.js"></script>
</body>
</html>