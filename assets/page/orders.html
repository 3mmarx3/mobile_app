<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>شوب أدمن - الطلبات والمستخدمين</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../style/style.css">
</head>
<body>
 
    <header id="header"></header>

    <div class="main-content">
        <div class="header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 class="mb-0" id="page-title">إدارة الطلبات</h2>
            </div>
            <div class="user-info">
                <span>مرحباً، <strong>المشرف العام</strong></span>
                <img src="https://ui-avatars.com/api/?name=المشرف+العام&background=6366f1&color=fff" alt="المشرف">
            </div>
        </div>

        <div id="page-container">
        
            <div id="orders" class="page active">
                <div class="container-fluid">
                    <div class="d-flex justify-content-between align-items-center mb-4 page-header">
                        <h2 class="mb-0">جميع الطلبات (<span id="ordersCount">0</span>)</h2>
                    </div>

                    <div class="card-custom">
                        <div class="table-responsive table-responsive-custom">
                            <table class="table table-custom">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllOrders"></th>
                                        <th>رقم الطلب</th>
                                        <th>العميل</th>
                                        <th>رقم الموبايل</th>
                                        <th>التاريخ</th>
                                        <th>الوقت</th>
                                        <th>العناصر</th>
                                        <th>الإجمالي</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody">
                                    <tr><td colspan="10" class="text-center">جارِ تحميل الطلبات...</td></tr>
                                </tbody>
                            </table>
                            <div id="noOrdersMessage" class="text-center p-3" style="display: none;">لا توجد طلبات حاليًا.</div>
                        </div>
                    </div>
                </div>

                <div class="modal modal-custom fade" id="orderModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">تفاصيل الطلب - <span id="modalOrderId"></span></h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-4 order-summary">
                                    <div class="col-md-6">
                                        <h5>العميل</h5>
                                        <p>
                                            <strong id="modalCustomerName"></strong><br>
                                            <span id="modalCustomerEmail"></span><br>
                                            <span id="modalCustomerPhone"></span>
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>عنوان الشحن</h5>
                                        <p><span id="modalShippingAddress"></span></p>
                                    </div>
                                </div>

                                <h5>عناصر الطلب</h5>
                                    <table class="table table-striped table-custom mt-3">
                                        <thead>
                                            <tr>
                                                <th>المنتج</th>
                                                <th>الكمية</th>
                                                <th>السعر</th>
                                                <th>الإجمالي</th>
                                            </tr>
                                        </thead>
                                        <tbody id="modalOrderItemsBody">
                                            <tr>
                                                <td colspan="4" class="text-center">لا توجد تفاصيل متاحة حاليًا.</td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="3" class="text-end"><strong>الإجمالي الفرعي</strong></td>
                                                <td id="modalSubtotal">0.00 ج.م</td>
                                            </tr>
                                            <tr>
                                                <td colspan="3" class="text-end"><strong>الإجمالي</strong></td>
                                                <td><strong id="modalTotal" style="color:#059669">0.00 ج.م</strong></td>
                                            </tr>
                                        </tfoot>
                                    </table>

                                <div class="d-flex justify-content-between align-items-center mt-4">
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-custom btn-danger" id="deleteOrderBtn">حذف الطلب</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="users" class="page">
                <div class="container-fluid">
                    <div class="d-flex justify-content-between align-items-center mb-4 page-header">
                        <h2 class="mb-0">جميع المستخدمين</h2>
                    </div>

                    <div class="card-custom">
                        <div class="table-responsive table-responsive-custom">
                            <table class="table table-custom">
                                <thead>
                                    <tr>
                                        <th>المستخدم</th>
                                        <th>البريد</th>
                                        <th>الهاتف</th>
                                        <th>الطلبات</th>
                                        <th>تاريخ الانضمام</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <img src="https://ui-avatars.com/api/?name=أحمد+محمد&background=6366f1&color=fff" class="user-avatar">
                                            <strong>أحمد محمد</strong>
                                        </td>
                                        <td>ahmed@example.com</td>
                                        <td>+20 111 222 3334</td>
                                        <td>24 طلب</td>
                                        <td>2024-03-15</td>
                                        <td><span class="badge badge-custom active">نشط</span></td>
                                        <td>
                                            <label class="switch me-2">
                                                <input type="checkbox" checked onchange="toggleUser(this,'أحمد')">
                                                <span class="slider"></span>
                                            </label>

                                            <span style="cursor: pointer;" onclick="openUserModal('أحمد محمد','ahmed@example.com','+201112223334','24','2024-03-15','القاهرة',true)">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
                                                  <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z"/>
                                                  <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0"/>
                                                </svg> 
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="modal modal-custom fade" id="userModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">الملف الشخصي</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center">
                                <img id="modalAvatar" src="" class="user-avatar mb-3" style="width:120px;height:120px;">
                                <h4 id="modalName" class="mb-3">أحمد محمد</h4>
                                <p class="mb-1"><strong>البريد:</strong> <span id="modalEmail"></span></p>
                                <p class="mb-4"><strong>الهاتف:</strong> <span id="modalPhone"></span></p>

                                <div class="row mb-4 user-info-grid">
                                    <div class="col-6 col-md-4 mb-3">
                                        <p class="mb-1"><strong>إجمالي الطلبات</strong></p>
                                        <h4 id="modalOrders" class="text-primary"></h4>
                                    </div>
                                    <div class="col-6 col-md-4 mb-3 d-none">
                                        <p class="mb-1"><strong>عضو منذ</strong></p>
                                        <h5 id="modalJoined" class="text-primary"></h5>
                                    </div>
                                    <div class="col-6 col-md-4 mb-3">
                                        <p class="mb-1"><strong>الموقع</strong></p>
                                        <span id="modalLocation"></span>
                                    </div>
                                    <div class="col-6 col-md-3 mb-3">
                                        <p class="mb-1"><strong>الحالة</strong></p>
                                        <span id="modalStatus" class="badge badge-custom active"></span>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-center gap-2">
                                    <button class="btn btn-custom btn-danger" onclick="if(confirm('حظر المستخدم؟')) alert('تم الحظر!')">حظر المستخدم</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../app/header.js"></script>
    
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDlKhp5gKE6l5BFBOBcLv6JZB3xIOnwqDo",
        authDomain: "shop-732bb.firebaseapp.com",
        projectId: "shop-732bb",
        storageBucket: "shop-732bb.firebasestorage.app",
        messagingSenderId: "650792166626",
        appId: "1:650792166626:web:4ae7de7821542520096abb"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const ordersColRef = collection(db, 'orders');
    const usersColRef = collection(db, 'users');

    const ordersTableBody = document.getElementById('ordersTableBody');
    const ordersCountElement = document.getElementById('ordersCount');
    const noOrdersMessage = document.getElementById('noOrdersMessage');
    const orderModal = new bootstrap.Modal(document.getElementById('orderModal'));

    let allOrders = [];
    let usersMap = {};
    let currentOrderId = null;

    function formatStatus(status) {
        switch (status) {
            case 'pending': return 'قيد الانتظار';
            case 'PROCESSING': 
            case 'processing': return 'قيد المعالجة';
            case 'SHIPPED':
            case 'shipped': return 'تم الشحن';
            case 'DELIVERED':
            case 'delivered': return 'تم التسليم';
            case 'CANCELLED':
            case 'canceled': return 'ملغي';
            default: return status;
        }
    }

    function formatTime(timeStr) {
        if (!timeStr || timeStr === 'غير متوفر' || timeStr === 'null') return 'غير متوفر';

        if (timeStr.toString().includes('PM') || timeStr.toString().includes('AM')) {
            return timeStr;
        }

        const parts = timeStr.split(':');
        if (parts.length >= 2) {
            const hours = parseInt(parts[0]);
            const minutes = parseInt(parts[1]);

            if (!isNaN(hours)) {
                let h = hours % 12;
                h = h ? h : 12;
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const minStr = !isNaN(minutes) ? minutes.toString().padStart(2, '0') : '00';
                return `${h}:${minStr} ${ampm}`;
            }
        }
        return timeStr;
    }

    function createStatusSelect(orderId, currentStatus) {
        const normalizedStatus = currentStatus ? currentStatus.toLowerCase() : 'processing';
        const statuses = ['processing', 'shipped', 'delivered', 'cancelled'];
        
        let options = statuses.map(status => {
            const label = formatStatus(status);
            const selected = status === normalizedStatus ? 'selected' : '';
            return `<option value="${status.toUpperCase()}" ${selected}>${label}</option>`;
        }).join('');

        return `<select class="status-select" onchange="updateOrderStatus('${orderId}', this.value)">${options}</select>`;
    }

    function getOrderNumber(order) {
        return `#${order.id.slice(-8)}`;
    }

    function getUserName(userId) {
        return usersMap[userId]?.name || usersMap[userId]?.displayName || usersMap[userId]?.username || 'غير متوفر';
    }

    function getUserPhone(userId) {
        return usersMap[userId]?.phone || usersMap[userId]?.mobile || 'غير متوفر';
    }

    function getUserEmail(userId) {
        return usersMap[userId]?.email || 'غير متوفر';
    }

    function renderOrdersTable(orders) {
        ordersTableBody.innerHTML = '';
        allOrders = orders;
        ordersCountElement.textContent = orders.length;

        if (orders.length === 0) {
            ordersTableBody.innerHTML = '';
            noOrdersMessage.style.display = 'block';
            return;
        }
        
        noOrdersMessage.style.display = 'none';

        orders.forEach(order => {
            const orderNumber = getOrderNumber(order);
            
            const itemsList = order.items || order.state || [];
            const itemsCount = order.itemsCount || itemsList.length || 0;
            
            const total = order.totalPrice || order.Total || 0;
            
            const userId = order.userId || order.uId || order.uid || order.customerId;
            const userName = getUserName(userId) || order.userName || order.UserName || order.name || 'غير متوفر';
            const userPhone = getUserPhone(userId) || order.phone || 'غير متوفر';

            const orderDate = order.orderDate || 'غير متوفر';
            const rawTime = order.orderTime || 'غير متوفر';
            const orderTime = formatTime(rawTime);

            const row = `
                <tr>
                    <td><input type="checkbox" class="row-check"></td>
                    <td><strong>${orderNumber}</strong></td>
                    <td><strong>${userName}</strong></td>
                    <td>${userPhone}</td>
                    <td>${orderDate}</td>
                    <td>${orderTime}</td>
                    <td>${itemsCount} عنصر</td>
                    <td><strong>${Number(total).toFixed(2)} ج.م</strong></td>
                    <td>${createStatusSelect(order.id, order.status)}</td>
                    <td style="cursor: pointer;" onclick="openOrderModal('${order.id}')">
                        عرض التفاصيل
                    </td>
                </tr>
            `;
            ordersTableBody.insertAdjacentHTML('beforeend', row);
        });
    }

    function loadUsers() {
        onSnapshot(usersColRef, (snapshot) => {
            snapshot.docs.forEach(doc => {
                usersMap[doc.id] = doc.data();
            });
            
            if (allOrders.length > 0) {
                renderOrdersTable(allOrders);
            }
        });
    }

    function loadOrders() {
        onSnapshot(ordersColRef, (snapshot) => {
            const ordersList = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            renderOrdersTable(ordersList);
        }, (error) => {
            ordersTableBody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">خطأ في الاتصال بقاعدة البيانات.</td></tr>`;
            noOrdersMessage.style.display = 'none';
        });
    }

    onAuthStateChanged(auth, (user) => {
        if (user) {
            loadUsers();
            loadOrders();
        } else {
            loadUsers();
            loadOrders(); 
        }
    });

    window.updateOrderStatus = async (orderId, newStatus) => {
        try {
            const orderRef = doc(db, 'orders', orderId);
            await updateDoc(orderRef, {
                status: newStatus
            });
            alert(`تم تحديث حالة الطلب إلى: ${formatStatus(newStatus)}`);
        } catch (error) {
            alert("حدث خطأ أثناء تحديث حالة الطلب.");
        }
    };

    window.deleteCurrentOrder = async () => {
        if (!currentOrderId) return;
        if (!confirm('هل أنت متأكد من حذف هذا الطلب نهائياً؟ هذا الإجراء لا يمكن التراجع عنه.')) return;

        try {
            const orderRef = doc(db, 'orders', currentOrderId);
            await deleteDoc(orderRef);
            alert('تم حذف الطلب بنجاح.');
            orderModal.hide();
        } catch (error) {
            alert('حدث خطأ أثناء حذف الطلب.');
        }
    };

    window.openOrderModal = (orderId) => {
        const order = allOrders.find(o => o.id === orderId);

        if (!order) {
            alert('لم يتم العثور على تفاصيل الطلب.');
            return;
        }

        currentOrderId = orderId;

        const userId = order.userId || order.uId || order.uid || order.customerId;
        
        document.getElementById('modalOrderId').textContent = getOrderNumber(order);
        
        document.getElementById('modalCustomerName').textContent = getUserName(userId) || order.userName || order.UserName || order.name || 'غير متوفر';
        document.getElementById('modalCustomerEmail').textContent = getUserEmail(userId) || order.email || 'غير متوفر';
        document.getElementById('modalCustomerPhone').textContent = getUserPhone(userId) || order.phone || 'غير متوفر';
        
        const shippingAddress = usersMap[userId]?.location || 'غير متوفر';
        document.getElementById('modalShippingAddress').textContent = shippingAddress;

        const items = order.items || order.state || [];
        
        const itemsBody = document.getElementById('modalOrderItemsBody');
        itemsBody.innerHTML = '';
        
        if (items.length > 0) {
            let runningSubtotal = 0;
            items.forEach(item => {
                const quantity = item.count || item.Count || 1;
                const price = item.price || item.Total || 0;
                const itemName = item.name || 'منتج غير معروف';
                
                const itemTotal = quantity * price;
                runningSubtotal += itemTotal;
                
                const row = `
                    <tr>
                        <td>${itemName}</td>
                        <td>${quantity}</td>
                        <td>${Number(price).toFixed(2)} ج.م</td>
                        <td>${itemTotal.toFixed(2)} ج.م</td>
                    </tr>
                `;
                itemsBody.insertAdjacentHTML('beforeend', row);
            });
            
            const finalTotal = order.totalPrice || runningSubtotal;

            document.getElementById('modalSubtotal').textContent = `${Number(finalTotal).toFixed(2)} ج.م`;
            document.getElementById('modalTotal').textContent = `${Number(finalTotal).toFixed(2)} ج.م`;
        
        } else {
            itemsBody.innerHTML = '<tr><td colspan="4" class="text-center">لا توجد عناصر مفصلة لهذا الطلب.</td></tr>';
            const total = order.totalPrice || order.Total || 0;
            document.getElementById('modalSubtotal').textContent = `${Number(total).toFixed(2)} ج.م`;
            document.getElementById('modalTotal').textContent = `${Number(total).toFixed(2)} ج.م`;
        }

        document.getElementById('deleteOrderBtn').onclick = deleteCurrentOrder;

        orderModal.show();
    };
</script>
    <script>
        function saveToLocalStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        function getFromLocalStorage(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : null;
        }

        const userModal = new bootstrap.Modal(document.getElementById('userModal'));
        
        document.getElementById('mobileMenuBtn').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('active');
        });

        document.addEventListener('click', (e) => {
            const sidebar = document.getElementById('sidebar');
            const mobileBtn = document.getElementById('mobileMenuBtn');

            if (window.innerWidth < 992 && 
                sidebar.classList.contains('active') && 
                !sidebar.contains(e.target) && 
                e.target !== mobileBtn && 
                !mobileBtn.contains(e.target)) {
                sidebar.classList.remove('active');
            }
        });

        function logout() {
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                localStorage.removeItem('adminLoggedIn');
                window.location.href = './auth/login.html';
            }
            return false;
        }

        function toggleUser(checkbox, name) {
            alert(`المستخدم ${name} أصبح ${checkbox.checked ? 'نشط' : 'غير نشط'}`);
        }

        function openUserModal(name, email, phone, orders, joined, location, active) {
            document.getElementById('modalAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=${active?'6366f1':'ef4444'}&color=fff`;
            document.getElementById('modalName').textContent = name;
            document.getElementById('modalEmail').textContent = email;
            document.getElementById('modalPhone').textContent = phone;
            document.getElementById('modalOrders').textContent = orders;
            document.getElementById('modalJoined').textContent = joined;
            document.getElementById('modalLocation').textContent = location;

            const st = document.getElementById('modalStatus');
            st.textContent = active ? 'نشط' : 'غير نشط';
            st.className = 'badge badge-custom ' + (active ? 'active' : 'inactive');

            userModal.show();
        }

        document.getElementById('selectAllOrders')?.addEventListener('click', (e) => {
            const isChecked = e.target.checked;
            document.querySelectorAll('#orders .row-check').forEach(cb => cb.checked = isChecked);
        });

        window.addEventListener('resize', () => {
            if (window.innerWidth >= 992) {
                document.getElementById('sidebar').classList.remove('active');
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const isLoggedIn = getFromLocalStorage('adminLoggedIn');
            if (!isLoggedIn && window.location.pathname.includes('dashboard')) {
                window.location.href = './auth/login.html';
            }
        });
    </script>
</body>
</html>